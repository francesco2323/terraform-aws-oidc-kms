name: "Terraform CI"

on:
    pull_request:
        branches: [main]

permissions:
    id-token: write
    contents: read
    pull-requests: write

jobs:
    terraform-ci:
        name: "Standardized CI"
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Required for SonarQube

            # --- LINTING (TFLint) ---
            - name: Setup TFLint
              uses: terraform-linters/setup-tflint@v3
              with:
                  tflint_version: latest

            - name: Init TFLint
              run: tflint --init

            - name: Run TFLint
              id: tflint
              run: |
                  tflint --format compact > tflint_report.txt || true
                  cat tflint_report.txt

            # --- SECURITY (Trivy) ---
            - name: Run Trivy Scan
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "config"
                  hide-progress: true
                  format: "table"
                  exit-code: "0"
                  output: "trivy_report.txt"

            # --- QUALITY (SonarQube) ---
            - name: SonarQube Scan
              uses: sonarsource/sonarqube-scan-action@master
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
              continue-on-error: true

            # --- TERRAFORM VALIDATE ---
            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: "1.10.5"

            - name: Terraform Init
              run: terraform init -backend=false

            - name: Terraform Validate
              id: validate
              run: terraform validate -no-color

            # --- PR SUMMARY ---
            - name: PR Feedback
              uses: actions/github-script@v7
              if: github.event_name == 'pull_request'
              with:
                  script: |
                      const fs = require('fs');
                      const tflintReport = fs.existsSync('tflint_report.txt') ? fs.readFileSync('tflint_report.txt', 'utf8') : 'No issues found';
                      const trivyReport = fs.existsSync('trivy_report.txt') ? fs.readFileSync('trivy_report.txt', 'utf8') : 'No issues found';

                      const output = `### ü§ñ CI/CD Standardized Report

                      #### üîç TFLint Status
                      \`\`\`
                      ${tflintReport}
                      \`\`\`

                      #### üõ°Ô∏è Security Scan (Trivy)
                      <details><summary>Show Trivy Report</summary>

                      \`\`\`
                      ${trivyReport}
                      \`\`\`

                      </details>

                      #### üèóÔ∏è Terraform Validation
                      - Outcome: \`${{ steps.validate.outcome }}\`

                      ---
                      *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: output
                      })
