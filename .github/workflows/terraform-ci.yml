name: "Terraform CI"

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  terraform-ci:
    name: "Hardened CI"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- LINTING (TFLint) ---
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v3
        with:
          tflint_version: latest

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        id: tflint
        run: |
          echo "### TFLint Report" > tflint_report.txt
          tflint --format compact >> tflint_report.txt || exit 1

      # --- SECURITY (Trivy) ---
      - name: Run Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "config"
          hide-progress: true
          format: "json"
          output: "trivy_report.json"
          exit-code: "1"
          severity: "CRITICAL,HIGH"

      # --- QUALITY (SonarQube) ---
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        continue-on-error: true

      # --- TERRAFORM VALIDATE ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.10.5"

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      # --- PR SUMMARY (Enhanced) ---
      - name: PR Feedback
        uses: actions/github-script@v7
        if: always() && github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');

            // Parse TFLint
            let tflintOutput = "âœ… No linting issues found.";
            if (fs.existsSync('tflint_report.txt')) {
              tflintOutput = fs.readFileSync('tflint_report.txt', 'utf8');
            }

            // Parse Trivy JSON for better detail
            let securitySummary = "âœ… No Critical/High vulnerabilities found.";
            let remediations = "";
            if (fs.existsSync('trivy_report.json')) {
              const trivyData = JSON.parse(fs.readFileSync('trivy_report.json', 'utf8'));
              if (trivyData.Results) {
                let issues = [];
                trivyData.Results.forEach(res => {
                  if (res.Misconfigurations) {
                    res.Misconfigurations.forEach(m => {
                      issues.push(`- **${m.ID}** (${m.Severity}): ${m.Title}\n  *Solution: ${m.Resolution}* [More info](${m.PrimaryURL})`);
                    });
                  }
                });
                if (issues.length > 0) {
                  securitySummary = `âŒ Found ${issues.length} security issues.`;
                  remediations = `#### ğŸ› ï¸ Security Remediations\n${issues.join('\n')}`;
                }
              }
            }

            const output = `### ğŸ›¡ï¸ Hardened CI/CD Report

            | Tool | Status |
            | :--- | :--- |
            | **TFLint** | ${tflintOutput.includes('âŒ') || tflintOutput.length > 20 ? 'âŒ Failed' : 'âœ… Passed'} |
            | **Security (Trivy)** | ${remediations ? 'âŒ Blocked' : 'âœ… Passed'} |
            | **Validation** | \`${{ steps.validate.outcome }}\` |

            #### ğŸ” Linting Details
            \`\`\`
            ${tflintOutput}
            \`\`\`

            ${remediations}

            ---
            *Note: Merge is blocked if Security or Linting status is âŒ.*
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
